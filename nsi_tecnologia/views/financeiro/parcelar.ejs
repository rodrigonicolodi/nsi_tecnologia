<% layout = 'layout' %>
<% titulo = 'Parcelar Lançamento' %>

<div class="container">
  <h2>Parcelar Lançamento</h2>

  <% if (erro) { %>
    <p class="erro"><%= erro %></p>
  <% } %>

  <!-- Informações do lançamento atual -->
  <div class="card" style="margin-bottom: 20px;">
    <h3>Lançamento Atual</h3>
    <div class="info-grid">
      <div class="info-item">
        <label>Tipo:</label>
        <span><%= lancamento.tipo === 'receber' ? 'Receber' : 'Pagar' %></span>
      </div>
      <div class="info-item">
        <label>Pessoa:</label>
        <span><%= lancamento.pessoa_nome %></span>
      </div>
      <div class="info-item">
        <label>Valor Atual:</label>
        <span class="valor-atual">R$ <%= parseFloat(lancamento.valor).toFixed(2) %></span>
      </div>
      <div class="info-item">
        <label>Vencimento Atual:</label>
        <span><%= new Date(lancamento.vencimento).toLocaleDateString() %></span>
      </div>
      <div class="info-item">
        <label>Status:</label>
        <span class="status-<%= lancamento.status %>">
          <%= lancamento.status === 'pago' ? 'Pago' : 
              lancamento.status === 'pendente' ? 'Pendente' : 'Cancelado' %>
        </span>
      </div>
    </div>
    <div class="info-item" style="margin-top: 15px;">
      <label>Descrição:</label>
      <p style="margin-top: 5px; padding: 10px; background-color: #f5f5f5; border-radius: 4px;"><%= lancamento.descricao %></p>
    </div>
  </div>

  <!-- Formulário de Parcelamento -->
  <form method="POST" action="/financeiro/parcelar/<%= lancamento.id %>" class="form-coluna">
    <h3>Configuração do Parcelamento</h3>

    <div class="campo">
      <label>Número de Parcelas:</label>
      <input type="number" name="total_parcelas" id="total_parcelas" min="2" max="24" value="2" required>
      <small>Valor por parcela: <span id="valor-por-parcela">R$ <%= (parseFloat(lancamento.valor) / 2).toFixed(2) %></span></small>
    </div>

    <div class="campo">
      <label>Intervalo entre Parcelas (dias):</label>
      <input type="number" name="intervalo_dias" id="intervalo_dias" min="1" max="365" value="30" required>
    </div>

    <div class="campo">
      <label>Vencimento da 1ª Parcela:</label>
      <input type="date" name="vencimento" id="vencimento" value="<%= new Date(lancamento.vencimento).toISOString().split('T')[0] %>" required>
    </div>

    <div class="campo">
      <label>Caixa:</label>
      <select name="caixa_id" required>
        <% if (caixas.length > 0) { %>
          <% caixas.forEach(c => { %>
            <option value="<%= c.id %>" <%= lancamento.caixa_id === c.id ? 'selected' : '' %>><%= c.nome %></option>
          <% }) %>
        <% } else { %>
          <option disabled selected>⚠ Nenhum caixa disponível</option>
        <% } %>
      </select>
    </div>

    <div class="campo" style="grid-column: span 2;">
      <label>Observações Adicionais:</label>
      <textarea name="observacoes" rows="3" placeholder="Observações sobre o parcelamento..."></textarea>
    </div>

    <!-- Preview das parcelas -->
    <div class="campo" style="grid-column: span 2;">
      <label>Preview das Parcelas:</label>
      <div id="preview-parcelas" class="preview-parcelas">
        <!-- Será preenchido via JavaScript -->
      </div>
    </div>

    <div class="campo">
      <button type="submit" class="btn btn-azul" id="btn-parcelar">
        <i class="fas fa-cut"></i> Parcelar Lançamento
      </button>
      <a href="/financeiro" class="btn btn-azul" style="margin-left: 10px;">
        <i class="fas fa-arrow-left"></i> Cancelar
      </a>
    </div>
  </form>
</div>

<style>
.info-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  margin-top: 15px;
}

.info-item {
  display: flex;
  flex-direction: column;
  gap: 5px;
}

.info-item label {
  font-weight: 600;
  color: #666;
  font-size: 0.9em;
}

.info-item span {
  font-size: 1.1em;
}

.valor-atual {
  font-weight: bold;
  color: #1976d2;
  font-size: 1.2em !important;
}

.card {
  background: white;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  margin-bottom: 20px;
}

.card h3 {
  margin-bottom: 15px;
  color: #333;
  border-bottom: 2px solid #0077cc;
  padding-bottom: 10px;
}

.preview-parcelas {
  background-color: #f8f9fa;
  border: 1px solid #dee2e6;
  border-radius: 4px;
  padding: 15px;
  margin-top: 10px;
  max-height: 200px;
  overflow-y: auto;
}

.parcela-preview {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 0;
  border-bottom: 1px solid #e9ecef;
}

.parcela-preview:last-child {
  border-bottom: none;
}

.parcela-info {
  font-weight: 500;
  color: #495057;
}

.parcela-valor {
  font-weight: 600;
  color: #28a745;
}

.parcela-data {
  font-size: 0.9em;
  color: #6c757d;
}

.status-pago {
  color: #28a745;
  font-weight: 600;
}

.status-pendente {
  color: #ffc107;
  font-weight: 600;
}

.status-cancelado {
  color: #dc3545;
  font-weight: 600;
}

/* Garantir que os botões usem os estilos padrão */
.btn {
  display: inline-block;
  padding: 10px 20px;
  margin: 5px;
  text-decoration: none;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
  text-align: center;
  transition: all 0.3s ease;
}

.btn-azul {
  background-color: #0077cc;
  color: white;
}

.btn-azul:hover {
  background-color: #005fa3;
  color: white;
  text-decoration: none;
}
</style>

<script>
function atualizarPreview() {
  const totalParcelas = parseInt(document.getElementById('total_parcelas').value) || 2;
  const intervalo = parseInt(document.getElementById('intervalo_dias').value) || 30;
  const vencimento = new Date(document.getElementById('vencimento').value);
  const valorTotal = parseFloat('<%= lancamento.valor %>');
  const valorParcela = valorTotal / totalParcelas;

  // Atualizar valor por parcela
  document.getElementById('valor-por-parcela').textContent = `R$ ${valorParcela.toFixed(2)}`;

  // Gerar preview das parcelas
  let previewHTML = '';
  for (let i = 1; i <= totalParcelas; i++) {
    const dataVencimento = new Date(vencimento);
    dataVencimento.setDate(dataVencimento.getDate() + ((i - 1) * intervalo));
    
    previewHTML += `
      <div class="parcela-preview">
        <div>
          <div class="parcela-info">Parcela ${i}/${totalParcelas}</div>
          <div class="parcela-data">Vencimento: ${dataVencimento.toLocaleDateString()}</div>
        </div>
        <div class="parcela-valor">R$ ${valorParcela.toFixed(2)}</div>
      </div>
    `;
  }

  document.getElementById('preview-parcelas').innerHTML = previewHTML;
}

document.addEventListener('DOMContentLoaded', function () {
  const form = document.querySelector('form');
  const botao = document.getElementById('btn-parcelar');

  // Adicionar event listeners
  document.getElementById('total_parcelas').addEventListener('input', atualizarPreview);
  document.getElementById('intervalo_dias').addEventListener('input', atualizarPreview);
  document.getElementById('vencimento').addEventListener('change', atualizarPreview);

  form.addEventListener('submit', function () {
    botao.disabled = true;
    botao.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Parcelando...';
  });

  // Inicializar preview
  atualizarPreview();
});
</script>

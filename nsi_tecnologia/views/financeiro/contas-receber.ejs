<% layout = 'layout' %>
<% titulo = 'Relatório - Contas a Receber' %>

<div class="container">
  <h2>💰 Relatório - Contas a Receber</h2>

  <!-- 📊 Cards de Resumo -->
  <div class="cards-resumo">
    <div class="card card-vermelho">
      <div class="card-header">
        <i class="fas fa-exclamation-triangle"></i>
        <h3>Vencidas</h3>
      </div>
      <div class="card-value">
        R$ <%= parseFloat(totais.total_vencidas || 0).toFixed(2) %>
      </div>
    </div>

    <div class="card card-laranja">
      <div class="card-header">
        <i class="fas fa-clock"></i>
        <h3>Vence Hoje</h3>
      </div>
      <div class="card-value">
        R$ <%= parseFloat(totais.total_vencendo_hoje || 0).toFixed(2) %>
      </div>
    </div>

    <div class="card card-amarelo">
      <div class="card-header">
        <i class="fas fa-calendar-week"></i>
        <h3>Vence em 7 dias</h3>
      </div>
      <div class="card-value">
        R$ <%= parseFloat(totais.total_vencendo_7_dias || 0).toFixed(2) %>
      </div>
    </div>

    <div class="card card-azul">
      <div class="card-header">
        <i class="fas fa-hourglass-half"></i>
        <h3>Total Pendente</h3>
      </div>
      <div class="card-value">
        R$ <%= parseFloat(totais.total_pendentes || 0).toFixed(2) %>
      </div>
    </div>

    <div class="card card-verde">
      <div class="card-header">
        <i class="fas fa-check-circle"></i>
        <h3>Total Quitado</h3>
      </div>
      <div class="card-value">
        R$ <%= parseFloat(totais.total_quitadas || 0).toFixed(2) %>
      </div>
    </div>
  </div>

  <!-- 🔍 Filtros -->
  <form method="GET" action="/financeiro/contas-receber" class="filtros">
    <div class="campo">
      <label for="busca">Buscar:</label>
      <input type="text" name="busca" id="busca" placeholder="Descrição ou cliente" value="<%= busca %>">
    </div>

    <div class="campo">
      <label for="status_vencimento">Status de Vencimento:</label>
      <select name="status_vencimento" id="status_vencimento">
        <option value="todas" <%= status_vencimento === 'todas' ? 'selected' : '' %>>Todas</option>
        <option value="vencidas" <%= status_vencimento === 'vencidas' ? 'selected' : '' %>>Vencidas</option>
        <option value="vencendo_hoje" <%= status_vencimento === 'vencendo_hoje' ? 'selected' : '' %>>Vence Hoje</option>
        <option value="vencendo_7_dias" <%= status_vencimento === 'vencendo_7_dias' ? 'selected' : '' %>>Vence em 7 dias</option>
        <option value="pendentes" <%= status_vencimento === 'pendentes' ? 'selected' : '' %>>Pendentes</option>
        <option value="quitadas" <%= status_vencimento === 'quitadas' ? 'selected' : '' %>>Quitadas</option>
      </select>
    </div>

    <div class="campo">
      <button type="submit" class="btn btn-azul">
        <i class="fas fa-filter"></i> Filtrar
      </button>
    </div>

    <div class="campo">
      <a href="/pdf/contas-receber?busca=<%= encodeURIComponent(busca || '') %>&status_vencimento=<%= encodeURIComponent(status_vencimento || '') %>" class="btn btn-vermelho" target="_blank">
        <i class="fas fa-file-pdf"></i> Exportar PDF
      </a>
    </div>
  </form>

  <% if (erro) { %>
    <p class="erro"><%= erro %></p>
  <% } %>
  <% if (sucesso) { %>
    <p class="sucesso"><%= sucesso %></p>
  <% } %>

  <div class="table-wrapper">
    <table class="tabela">
      <thead>
        <tr>
          <th>Cliente</th>
          <th>Descrição</th>
          <th>Valor</th>
          <th>Parcelas</th>
          <th>Vencimento</th>
          <th>Status</th>
          <th>Dias</th>
          <th>Contato</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody>
        <% (lancamentos || []).forEach(l => { %>
          <tr class="<%= l.status_vencimento_real === 'vencida' ? 'linha-vencida' : '' %> <%= l.status_vencimento_real === 'vencendo_hoje' ? 'linha-vencendo-hoje' : '' %>">
            <td>
              <strong><%= l.pessoa_nome || '-' %></strong>
            </td>
            <td><%= l.descricao || '-' %></td>
            <td class="valor">
              <strong>R$ <%= parseFloat(l.valor).toFixed(2) %></strong>
            </td>
            <td>
              <% if (l.total_parcelas > 1) { %>
                <span class="parcela-info">
                  <%= l.parcela_atual || 1 %>/<%= l.total_parcelas || 1 %>
                  <% if (l.parcela_pai_id === l.id) { %>
                    <span class="parcela-principal" title="Parcela principal">👑</span>
                  <% } %>
                </span>
              <% } else { %>
                <span class="avista">À Vista</span>
              <% } %>
            </td>
            <td>
              <span class="data-vencimento <%= l.status_vencimento_real === 'vencida' ? 'vencida' : '' %> <%= l.status_vencimento_real === 'vencendo_hoje' ? 'vencendo-hoje' : '' %>">
                <%= l.vencimento ? new Date(l.vencimento).toLocaleDateString('pt-BR') : '-' %>
              </span>
            </td>
            <td>
              <span class="status-badge status-<%= l.status %>">
                <%= l.status || '-' %>
              </span>
            </td>
            <td class="dias-vencimento">
              <% if (l.vencimento && l.status === 'pendente') { %>
                <% 
                  const hoje = new Date();
                  const vencimento = new Date(l.vencimento);
                  const diffTime = vencimento - hoje;
                  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                %>
                <% if (diffDays < 0) { %>
                  <span class="dias-vencida">Há <%= Math.abs(diffDays) %> dias</span>
                <% } else if (diffDays === 0) { %>
                  <span class="dias-hoje">Hoje</span>
                <% } else if (diffDays <= 7) { %>
                  <span class="dias-proximo">Em <%= diffDays %> dias</span>
                <% } else { %>
                  <span class="dias-normal">Em <%= diffDays %> dias</span>
                <% } %>
              <% } else { %>
                <span class="dias-quitada">Quitado</span>
              <% } %>
            </td>
            <td class="contato">
              <% if (l.telefone) { %>
                <a href="tel:<%= l.telefone %>" title="Ligar">
                  <i class="fas fa-phone"></i>
                </a>
              <% } %>
              <% if (l.email) { %>
                <a href="mailto:<%= l.email %>" title="Enviar email">
                  <i class="fas fa-envelope"></i>
                </a>
              <% } %>
            </td>
            <td class="acoes">
              <a href="/financeiro/exibir/<%= l.id %>" class="btn btn-acao btn-azul" title="Exibir">
                <i class="fas fa-eye"></i>
              </a>
              <a href="/financeiro/editar/<%= l.id %>" class="btn btn-acao btn-azul" title="Editar">
                <i class="fas fa-edit"></i>
              </a>
              
              <% if (l.status === 'pendente') { %>
                <form action="/financeiro/quitar/<%= l.id %>" method="POST" style="display: inline-block; margin-top: 5px;">
                  <select name="caixa_quitacao_id" class="input-pequeno" required>
                    <% caixas.forEach(c => { %>
                      <option value="<%= c.id %>"><%= c.nome %></option>
                    <% }) %>
                  </select>
                  <button type="submit" class="btn btn-acao btn-verde" title="Quitar">
                    <i class="fas fa-check-circle"></i>
                  </button>
                </form>
              <% } else { %>
                <span class="status-quitado">Quitado</span>
              <% } %>
            </td>
          </tr>
        <% }) %>
        <% if (lancamentos.length === 0) { %>
          <tr>
            <td colspan="9">Nenhuma conta a receber encontrada.</td>
          </tr>
        <% } %>
      </tbody>
    </table>
  </div>

  <!-- 📄 Paginação -->
  <% if (totalPaginas > 1) { %>
    <div class="paginacao">
      <% for (let i = 1; i <= totalPaginas; i++) { %>
        <a href="?pagina=<%= i %>&busca=<%= encodeURIComponent(busca) %>&status_vencimento=<%= encodeURIComponent(status_vencimento) %>"
           class="btn-pagina <%= pagina === i ? 'ativo' : '' %>">
          <%= i %>
        </a>
      <% } %>
    </div>
  <% } %>
</div>

<style>
/* Cards de Resumo */
.cards-resumo {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}

.card {
  background: white;
  border-radius: 10px;
  padding: 20px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  transition: transform 0.3s ease;
}

.card:hover {
  transform: translateY(-2px);
}

.card-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 15px;
}

.card-header i {
  font-size: 1.2em;
}

.card-header h3 {
  margin: 0;
  font-size: 0.9em;
  font-weight: 600;
  color: #666;
}

.card-value {
  font-size: 1.8em;
  font-weight: bold;
  color: #333;
}

/* Cores dos cards */
.card-vermelho { border-left: 4px solid #dc3545; }
.card-vermelho .card-header i { color: #dc3545; }

.card-laranja { border-left: 4px solid #fd7e14; }
.card-laranja .card-header i { color: #fd7e14; }

.card-amarelo { border-left: 4px solid #ffc107; }
.card-amarelo .card-header i { color: #ffc107; }

.card-azul { border-left: 4px solid #007bff; }
.card-azul .card-header i { color: #007bff; }

.card-verde { border-left: 4px solid #28a745; }
.card-verde .card-header i { color: #28a745; }

/* Filtros */
.filtros {
  display: flex;
  gap: 15px;
  align-items: end;
  flex-wrap: wrap;
  margin-bottom: 20px;
  padding: 20px;
  background-color: #f8f9fa;
  border-radius: 8px;
}

.campo {
  display: flex;
  flex-direction: column;
  gap: 5px;
}

.campo label {
  font-weight: 600;
  color: #333;
  font-size: 0.9em;
}

.campo input,
.campo select {
  padding: 8px 12px;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 14px;
}

/* Estilos da tabela */
.linha-vencida {
  background-color: #ffeaea !important;
  border-left: 4px solid #dc3545 !important;
}

.linha-vencendo-hoje {
  background-color: #fff3cd !important;
  border-left: 4px solid #fd7e14 !important;
}

.valor {
  font-weight: bold;
  color: #28a745;
}

.data-vencimento.vencida {
  color: #dc3545;
  font-weight: bold;
}

.data-vencimento.vencendo-hoje {
  color: #fd7e14;
  font-weight: bold;
}

.status-badge {
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 0.8em;
  font-weight: 500;
  text-transform: uppercase;
}

.status-pendente {
  background-color: #fff3cd;
  color: #856404;
}

.status-pago {
  background-color: #d4edda;
  color: #155724;
}

.status-cancelado {
  background-color: #f8d7da;
  color: #721c24;
}

.dias-vencida {
  color: #dc3545;
  font-weight: bold;
}

.dias-hoje {
  color: #fd7e14;
  font-weight: bold;
}

.dias-proximo {
  color: #ffc107;
  font-weight: bold;
}

.dias-normal {
  color: #6c757d;
}

.dias-quitada {
  color: #28a745;
  font-weight: bold;
}

.contato {
  display: flex;
  gap: 10px;
}

.contato a {
  color: #007bff;
  text-decoration: none;
  font-size: 1.1em;
}

.contato a:hover {
  color: #0056b3;
}

.parcela-info {
  background-color: #e9ecef;
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 0.8em;
}

.parcela-principal {
  margin-left: 5px;
}

.avista {
  color: #6c757d;
  font-style: italic;
}

/* Botões de ação */
.btn-acao {
  padding: 5px 8px;
  margin: 2px;
  font-size: 0.8em;
}

.input-pequeno {
  padding: 4px 6px;
  font-size: 0.8em;
  width: 120px;
}

/* Responsividade */
@media (max-width: 768px) {
  .cards-resumo {
    grid-template-columns: 1fr;
  }
  
  .filtros {
    flex-direction: column;
    align-items: stretch;
  }
  
  .campo {
    width: 100%;
  }
}
</style>

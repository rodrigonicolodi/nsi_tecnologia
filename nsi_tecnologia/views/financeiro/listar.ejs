<% layout = 'layout' %>
<% titulo = 'Lan√ßamentos Financeiros' %>

<div class="container">
  <h2>Lan√ßamentos Financeiros</h2>

<div style="display: flex; gap: 10px; margin-bottom: 20px;">
  <a href="/financeiro/novo" class="btn btn-azul">
    <i class="fas fa-plus-circle"></i> Novo Lan√ßamento
  </a>

  <a href="/caixas/consulta" class="btn btn-azul">
    <i class="fas fa-search"></i> Consulta de Caixas
  </a>
</div>

  <!-- üîç Filtros -->
<!-- üîç Filtros -->
<form method="GET" action="/financeiro" class="form-filtros" style="display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap; margin-bottom: 20px;">
  <div class="campo">
    <label for="busca">Buscar</label>
    <input type="text" name="busca" id="busca" placeholder="Descri√ß√£o ou pessoa" value="<%= busca %>" class="input-busca">
  </div>

  <div class="campo">
    <label for="tipo">Tipo</label>
    <select name="tipo" id="tipo">
      <option value="">Todos</option>
      <option value="receber" <%= tipo === 'receber' ? 'selected' : '' %>>Receber</option>
      <option value="pagar" <%= tipo === 'pagar' ? 'selected' : '' %>>Pagar</option>
    </select>
  </div>

  <div class="campo">
    <label for="status">Status</label>
    <select name="status" id="status">
      <option value="">Todos</option>
      <option value="pendente" <%= status === 'pendente' ? 'selected' : '' %>>Pendente</option>
      <option value="pago" <%= status === 'pago' ? 'selected' : '' %>>Pago</option>
      <option value="cancelado" <%= status === 'cancelado' ? 'selected' : '' %>>Cancelado</option>
    </select>
  </div>

  <div class="campo">
    <button type="submit" class="btn btn-azul">
      <i class="fas fa-filter"></i> Filtrar
    </button>
  </div>
</form>
  <% if (erro) { %>
    <p class="erro"><%= erro %></p>
  <% } %>
  <% if (sucesso) { %>
    <p class="sucesso"><%= sucesso %></p>
  <% } %>

  <div class="table-wrapper">
    <table class="tabela">
      <thead>
        <tr>
          <th>Tipo</th>
          <th>Pessoa</th>
          <th>Caixa</th>
          <th>Valor</th>
          <th>Parcelas</th>
          <th>Vencimento</th>
          <th>Status</th>
          <th>Caixa Quita√ß√£o</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody>
        <% (lancamentos || []).forEach(l => { %>
          <tr>
            <td><%= l.tipo || '-' %></td>
            <td><%= l.pessoa_nome || '-' %></td>
            <td><%= l.caixa_origem_nome || '-' %></td>
            <td>R$ <%= !isNaN(parseFloat(l.valor)) ? parseFloat(l.valor).toFixed(2) : '0.00' %></td>
            <td>
              <% if (l.total_parcelas > 1) { %>
                <span class="parcela-info">
                  <%= l.parcela_atual || 1 %>/<%= l.total_parcelas || 1 %>
                  <% if (l.parcela_pai_id === l.id) { %>
                    <span class="parcela-principal" title="Parcela principal">üëë</span>
                  <% } %>
                </span>
              <% } else { %>
                <span class="avista">√Ä Vista</span>
              <% } %>
            </td>
            <td><%= l.vencimento ? new Date(l.vencimento).toLocaleDateString() : '-' %></td>
            <td><%= l.status || '-' %></td>
            <td><%= l.caixa_quitacao_nome || 'N√£o quitado' %></td>
            <td class="acoes">
  <a href="/financeiro/exibir/<%= l.id %>" class="btn btn-acao btn-azul" title="Exibir">
    <i class="fas fa-eye"></i>
  </a>
  <a href="/financeiro/editar/<%= l.id %>" class="btn btn-acao btn-azul" title="Editar">
    <i class="fas fa-edit"></i>
  </a>
  <% if (l.total_parcelas > 1) { %>
    <a href="/financeiro/parcelas/<%= l.parcela_pai_id || l.id %>" class="btn btn-acao btn-verde" title="Ver Parcelas">
      <i class="fas fa-list"></i>
    </a>
  <% } else { %>
    <a href="/financeiro/parcelar/<%= l.id %>" class="btn btn-acao btn-laranja" title="Parcelar">
      <i class="fas fa-cut"></i>
    </a>
  <% } %>
  <button type="button" class="btn btn-acao btn-vermelho" data-id="<%= l.id %>" title="Excluir">
    <i class="fas fa-trash-alt"></i>
  </button>

  <% if (l.status === 'pendente') { %>
    <form action="/financeiro/quitar/<%= l.id %>" method="POST" style="margin-top: 5px;">
      <select name="caixa_quitacao_id" class="input-pequeno" required>
        <% caixas.forEach(c => { %>
          <option value="<%= c.id %>"><%= c.nome %></option>
        <% }) %>
      </select>
      <button type="submit" class="btn btn-acao btn-verde" title="Quitar">
        <i class="fas fa-check-circle"></i>
      </button>
    </form>
  <% } else { %>
    <span class="status-quitado">Quitado</span>
  <% } %>
</td>
          </tr>
        <% }) %>
        <% if (lancamentos.length === 0) { %>
          <tr>
            <td colspan="8">Nenhum lan√ßamento encontrado.</td>
          </tr>
        <% } %>
      </tbody>
    </table>
  </div>

  <!-- üìÑ Pagina√ß√£o -->
  <% if (totalPaginas > 1) { %>
    <div class="paginacao">
      <% for (let i = 1; i <= totalPaginas; i++) { %>
        <a href="?pagina=<%= i %>&busca=<%= encodeURIComponent(busca) %>&tipo=<%= encodeURIComponent(tipo) %>&status=<%= encodeURIComponent(status) %>"
           class="btn-pagina <%= pagina === i ? 'ativo' : '' %>">
          <%= i %>
        </a>
      <% } %>
    </div>
  <% } %>
</div>

<!-- üîî Modal de confirma√ß√£o (opcional) -->
<div id="modal-confirmacao" class="modal">
  <div class="modal-conteudo">
    <p>Tem certeza que deseja excluir este lan√ßamento?</p>
    <form id="form-confirmar" method="POST">
      <button type="submit" class="btn btn-azul">Confirmar</button>
      <button type="button" class="btn btn-vermelho" onclick="fecharModal()">Cancelar</button>
    </form>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const modal = document.getElementById('modal-confirmacao');
    const formConfirmar = document.getElementById('form-confirmar');

    document.querySelectorAll('.btn-vermelho[data-id]').forEach(botao => {
      botao.addEventListener('click', () => {
        const id = botao.getAttribute('data-id');
        formConfirmar.setAttribute('action', `/financeiro/excluir/${id}`);
        modal.style.display = 'flex';
      });
    });

    window.fecharModal = function () {
      modal.style.display = 'none';
    };
  });
</script>
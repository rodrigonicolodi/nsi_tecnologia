<% layout = 'layout' %>
<% titulo = 'Estoque de Produtos' %>

<div class="container">
  <h2>Estoque de Produtos</h2>

<div style="display: flex; gap: 10px; margin-bottom: 20px;">
  <a href="/estoque/novo" class="btn btn-azul">
    <i class="fas fa-box-open"></i> Novo Produto
  </a>
</div>

  <!-- üîç Filtros e busca -->
  <form method="GET" action="/estoque" class="filtros">
    <div class="campo">
      <label for="busca">Buscar:</label>
      <input type="text" name="busca" id="busca" placeholder="Buscar por nome" value="<%= busca %>">
    </div>

    <div class="campo">
      <label for="categoria">Categoria:</label>
      <select name="categoria" id="categoria">
        <option value="">Todas as categorias</option>
        <option value="eletronico" <%= categoria === 'eletronico' ? 'selected' : '' %>>Eletr√¥nico</option>
        <option value="ferramenta" <%= categoria === 'ferramenta' ? 'selected' : '' %>>Ferramenta</option>
      </select>
    </div>

    <div class="campo">
      <label for="estado">Estado:</label>
      <select name="estado" id="estado">
        <option value="">Todos os estados</option>
        <option value="novo" <%= estado === 'novo' ? 'selected' : '' %>>Novo</option>
        <option value="usado" <%= estado === 'usado' ? 'selected' : '' %>>Usado</option>
      </select>
    </div>

    <div class="campo">
      <label for="status">Status:</label>
      <select name="status" id="status">
        <option value="">Todos os status</option>
        <option value="ativo" <%= status === 'ativo' ? 'selected' : '' %>>Ativo</option>
        <option value="inativo" <%= status === 'inativo' ? 'selected' : '' %>>Inativo</option>
      </select>
    </div>

    <div class="campo">
      <button type="submit" class="btn btn-azul">
        <i class="fas fa-filter"></i> Filtrar
      </button>
    </div>

    <div class="campo">
      <a href="/pdf/estoque?busca=<%= encodeURIComponent(busca || '') %>&categoria=<%= encodeURIComponent(categoria || '') %>&estado=<%= encodeURIComponent(estado || '') %>&status=<%= encodeURIComponent(status || '') %>" class="btn btn-vermelho" target="_blank">
        <i class="fas fa-file-pdf"></i> Exportar PDF
      </a>
    </div>
  </form>

  <% if (erro) { %>
    <p class="erro"><%= erro %></p>
  <% } %>
  <% if (sucesso) { %>
    <p class="sucesso"><%= sucesso %></p>
  <% } %>

  <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th>Nome</th>
          <th>C√≥digo</th>
          <th>Categoria</th>
          <th>Estado</th>
          <th>Estoque</th>
          <th>Status</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody>
        <% (produtos || []).forEach(p => { %>
          <tr>
            <td><%= p.nome %></td>
            <td><%= p.codigo %></td>
            <td><%= p.categoria %></td>
            <td>
              <span class="status <%= p.estado === 'novo' ? 'verde' : 'laranja' %>" style="padding: 3px 8px; border-radius: 12px; font-size: 0.8em;">
                <%= p.estado === 'novo' ? 'Novo' : 'Usado' %>
              </span>
            </td>
            <td><%= p.estoque_atual %></td>
            <td><%= p.status %></td>
            <td>
              <a href="/estoque/exibir/<%= p.id %>" class="btn btn-acao btn-azul" title="Exibir">
                <i class="fas fa-eye"></i>
              </a>
              <a href="/estoque/editar/<%= p.id %>" class="btn btn-acao btn-azul" title="Editar">
                <i class="fas fa-edit"></i>
              </a>
              <button type="button" class="btn btn-acao btn-vermelho" data-id="<%= p.id %>" title="Excluir">
                <i class="fas fa-trash-alt"></i>
              </button>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>

  <!-- üìÑ Pagina√ß√£o -->
  <% if (totalPaginas > 1) { %>
    <div class="paginacao">
      <% for (let i = 1; i <= totalPaginas; i++) { %>
        <a href="?pagina=<%= i %>&busca=<%= encodeURIComponent(busca) %>&categoria=<%= encodeURIComponent(categoria) %>&status=<%= encodeURIComponent(status) %>"
           class="btn-pagina <%= pagina === i ? 'ativo' : '' %>">
          <%= i %>
        </a>
      <% } %>
    </div>
  <% } %>
</div>

<!-- üîî Modal de confirma√ß√£o -->
<div id="modal-confirmacao" class="modal">
  <div class="modal-conteudo">
    <p>Tem certeza que deseja excluir este produto?</p>
    <form id="form-confirmar" method="POST">
      <button type="submit" class="btn btn-azul">Confirmar</button>
      <button type="button" class="btn btn-vermelho" onclick="fecharModal()">Cancelar</button>
    </form>
  </div>
</div>

<!-- üß† Script para controle do modal -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const modal = document.getElementById('modal-confirmacao');
    const formConfirmar = document.getElementById('form-confirmar');

    document.querySelectorAll('.btn-vermelho[data-id]').forEach(botao => {
      botao.addEventListener('click', () => {
        const id = botao.getAttribute('data-id');
        formConfirmar.setAttribute('action', `/estoque/excluir/${id}`);
        modal.style.display = 'flex';
      });
    });

    window.fecharModal = function () {
      modal.style.display = 'none';
    };
  });
</script>

<style>
.filtros {
    display: flex;
    gap: 15px;
    align-items: end;
    flex-wrap: wrap;
    margin-bottom: 20px;
    padding: 20px;
    background-color: #f8f9fa;
    border-radius: 8px;
}

.campo {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.campo label {
    font-weight: 600;
    color: #333;
    font-size: 0.9em;
}

.campo input,
.campo select {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
}

/* Estilos espec√≠ficos para filtros */
.filtros .btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 20px;
    text-decoration: none;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.3s ease;
}

.filtros .btn-azul {
    background-color: #0077cc;
    color: white;
}

.filtros .btn-azul:hover {
    background-color: #005fa3;
    color: white;
    text-decoration: none;
}

.filtros .btn-vermelho {
    background-color: #cc3300;
    color: white;
}

.filtros .btn-vermelho:hover {
    background-color: #a62800;
    color: white;
    text-decoration: none;
}
</style>